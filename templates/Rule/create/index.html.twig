{% extends 'base.html.twig' %}
{% block title %}{{ parent() }} | {{ 'title.rule.create'|trans }}{% endblock %}
{% block titlesm %}{{ 'title.rule.create'|trans }}{% endblock %}

{% block body %}

  <div class="container py-4" id="rule-create">

    {# --- SECTION 1 : Rule Details  --- #}
    {% include 'Rule/create/_details.html.twig' %}

    {# --- SECTION 2 : Rule Connection --- #}
    {% include 'Rule/create/_connection.html.twig' %}

    {# --- SECTION 3 : Synch Options --- #}
    {% include 'Rule/create/_sync.html.twig' %}
    
    {# --- SECTION 4 : Synch Options --- #}
    {% include 'Rule/create/_filters.html.twig' %}
    
    {# --- SECTION 5 : Synch Options --- #}
    {% include 'Rule/create/_mapping.html.twig' %}

<div id="rule-page"
     data-mode="{{ initialRuleJson is defined ? 'edit' : 'create' }}">
</div>

{% if initialRuleJson is defined %}
<script>
  window.initialRule = {{ initialRuleJson|raw }};
</script>
{% endif %}

  </div>

<!-- Offcanvas gauche -->
<div class="offcanvas offcanvas-start" data-bs-backdrop="false" data-bs-scroll="true" tabindex="-1" id="ruleCreateNav" aria-labelledby="ruleCreateNavLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="ruleCreateNavLabel">{{ 'title.rule.create'|trans }}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
  </div>
  <div class="offcanvas-body p-0">

    <!-- Menu -->
    <nav class="list-group list-group-flush">
      <a class="list-group-item list-group-item-action" href="#step-1" data-bs-dismiss="offcanvas">
        {{ 'animate.rulename'| trans }}
      </a>
      <a class="list-group-item list-group-item-action" href="#step-2" data-bs-dismiss="offcanvas">
        {{ 'animate.ruleconnection'| trans }}
      </a>
      <a class="list-group-item list-group-item-action" href="#step-3" data-bs-dismiss="offcanvas">
        {{ 'create_rule.step3.syncdata.title' | trans }}
      </a>
      <a class="list-group-item list-group-item-action" href="#step-4" data-bs-dismiss="offcanvas">
        {{ 'create_rule.step4.title' | trans }}
      </a>
      <a class="list-group-item list-group-item-action" href="#step-5" data-bs-dismiss="offcanvas">
        {{ 'create_rule.step5.title' | trans }}
      </a>
    </nav>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // on récupère l’offcanvas Bootstrap
    const offcanvasEl = document.getElementById('ruleCreateNav');
    const bsOffcanvas = offcanvasEl ? bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl) : null;

    // on écoute les clics sur les liens internes
    document.addEventListener('click', function (e) {
      const link = e.target.closest('a[href^="#"]');
      if (!link) return;

      const targetSelector = link.getAttribute('href');
      const target = document.querySelector(targetSelector);
      if (!target) return;

      // si le lien est dans l’offcanvas → on le ferme d’abord
      const isInsideOffcanvas = link.closest('.offcanvas') !== null;

      e.preventDefault();

      if (isInsideOffcanvas && bsOffcanvas) {
        // on attend la fermeture pour scroller
        const handleHidden = function () {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          offcanvasEl.removeEventListener('hidden.bs.offcanvas', handleHidden);
        };
        offcanvasEl.addEventListener('hidden.bs.offcanvas', handleHidden);
        bsOffcanvas.hide();
      } else {
        // lien normal dans la page
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });
</script>
{% endblock %}
