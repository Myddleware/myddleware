{% extends 'base.html.twig' %}

{% block title %}
	{{ parent() }}
	|
	{{ 'view_workflow.title'|trans }}
{% endblock %}

{% block titlesm %}
	{{ 'view_workflow.title'|trans }}
	<i class="fa-solid fa-arrow-right fa-flip arrow-cut-animation fa-solid fa-arrow-right fa-flip"></i>
	{{ workflow.name }}
{% endblock titlesm %}
{% block body %}
	<div id="workflows">
		<div>

			<a href="{{ path('workflow_list') }}" class="btn btn-outline-primary m-2">
				{{ 'view_workflow.back'| trans }}</a>
			<a href="{{ path('workflow_edit', {'id': workflow.id}) }}" class="btn btn-outline-success m-2">
				{{ 'view_workflow.edit'| trans }}</a>
			<form method="post" action="{{ path('workflow_delete', {'id': workflow.id}) }}" style="display: inline;">
				<button type="submit" 
						onclick="return confirm('Are you sure you want to delete this workflow ?');" 
						class="btn btn-outline-danger m-2">
					{{ 'view_workflow.delete'| trans }}
				</button>
			</form>
		</div>

		<div class="link-help-view text-end mb-4 mx-4">
			<a href="https://myddleware.github.io/myddleware/#/advanced_usage?id=workflows">
				<i class="fa fa-info-circle" aria-hidden="true"></i>
				{{ 'rule.help' | trans }}
			</a>
		</div>


		<div>
			{% for message in app.flashes('success') %}
				<div class="alert alert-success" role="alert">
					{{ message }}
				</div>
			{% endfor %}

			{% if workflow is not null %}
				<div class="workflow-details container mt-4">
					<div class="card-header mb-4 card-title-workflow">
						{{ 'view_workflow.title'| trans | upper }}
					</div>
					<div id="workflow-content" class="collapse show">
						<div class="workflow-row mb-2">
							<div class="workflow-col mb-2">
								<strong>{{ 'view_workflow.name'| trans | upper }}</strong>
								<div>{{ workflow.name }}</div>
							</div>
							<div class="workflow-col mb-2">
								<strong>{{ 'view_workflow.create_by'| trans| upper }}</strong>
								<div>{{ workflow.createdBy.username }}</div>
							</div>
						</div>
						<div class="workflow-row mb-2">
							<div class="workflow-col mb-2">
								<strong>{{ 'view_workflow.rule'| trans | upper }}</strong>
								<div>
									<a href="{{ path('regle_open', {'id': workflow.rule.id}) }}" class="help-link all-link">{{ workflow.rule.name }}</a>

								</div>
							</div>
							<div class="workflow-col mb-2">
								<strong>{{ 'view_workflow.status'| trans | upper }}</strong>
								<div class="form-check form-switch text-center">
									<input class="workflow_status form-check-input workflow-check-input" type="checkbox" id="activeWorkflow_{{ workflow.id }}" data-id="{{ workflow.id }}" data-type="workflow" {{ workflow.active ? 'checked' : '' }}>
								</div>
							</div>
						</div>
						<div class="workflow-row mb-2">
							<div class="workflow-col mb-2">
								<strong>{{ 'view_workflow.description'| trans | upper }}</strong>
								<div>{{ workflow.description }}</div>
							</div>
						</div>
						<div class="card m-4">
							<div class="mb-4">
								<strong>
									{{ 'list_workflow.th.condition'| trans| upper }}</strong>
							</div>
							<div class="m-2">
								<div>{{ workflow.condition }}</div>
							</div>
						</div>
					</div>
				</div>

				{# LIST ACTION #}
				<div class="container mt-5">
					<div class="card-header mb-4 card-title-workflow">
						<button class="minus-workflow-actions toggle-button btn btn-outline-secondary btn-sm float-end" data-bs-toggle="collapse" data-bs-target="#actions-content" aria-expanded="true" aria-controls="actions-content">
							<i class="fa fa-minus"></i>
						</button>
						{{ 'view_workflow.actions_list'| trans | upper }}
					</div>

					<div id="actions-content" class="collapse show">

						<table class="table">
							<thead>
								<tr>
									<th>{{ 'view_workflow.name'|trans }}</th>
									<th>{{ 'view_workflow.action'|trans }}</th>
									<th>{{ 'view_workflow.description'|trans }}</th>
									<th>{{ 'view_workflow.order'|trans }}</th>
									<th>{{ 'view_workflow.arguments'|trans }}</th>
									<th>{{'list_workflow.th.status'|trans}}</th>
									<th>{{'list_workflow.th.option'|trans}}</th>

								</tr>
							</thead>
							<tbody class="workflow-actions-collapse-body">
								{% for action in workflow.getWorkflowActions %}
									<tr>
										<td class="text-center">
											<a href="{{ path('workflow_action_show', {'id': action.id}) }}" class="help-link all-link">{{ action.name }}</a>
										</td>
										<td class="text-center">{{ action.action }}</td>
										<td class="text-center">{{ action.description }}</td>
										<td class="text-center">{{ action.order }}</td>
										<td class="text-center">
											{% if action.arguments is iterable %}
												<ul>

													{% for key, argument in action.arguments %}
														<li>{{ key }}:
															{% if argument is iterable %}
																<ul>
																	{% for subKey, subArgument in argument %}
																		<li>{{ subKey }}:
																			{{ subArgument }}</li>
																	{% endfor %}
																</ul>
															{% else %}
																{{ argument }}
															{% endif %}
														</li>
													{% endfor %}
												</ul>
											{% else %}
												{{ action.arguments }}
											{% endif %}
										</td>
										<td class="value workflow_on_off">
											<div class="mb-2">
								<div class="form-check form-switch">
									<input class="form-check-input workflow-check-input workflow-action-list-inside-workflow-show" type="checkbox" id="activeWorkflowAction_{{ action.id }}" data-id="{{ action.id }}" data-type="workflowAction" {{ action.active ? 'checked' : '' }}>
								</div>
							</div>
										</td>
										<td class="CRUD-icons text-center">
											<a href="{{ path('workflow_action_show', {'id': action.id}) }}" title="{{ 'list_rule.btn.view'|trans }}"  class="btn btn-sm btn-outline-success">
												<span class="btn-opt">
													<i class="fa fa-eye" aria-hidden="true"></i>
												</span>
											</a>
											<a href="{{ path('workflow_action_edit', {'id': action.id}) }}" title="{{ 'list_rule.btn.edit'|trans }}"  class="btn btn-sm btn-outline-primary">
												<span class="btn-opt">
													<i class="fa fa-pen" aria-hidden="true"></i>
												</span>
											</a>
											<form method="post" action="{{ path('workflow_action_delete', {'id': action.id}) }}" style="display: inline;">
												<button type="submit" 
														class="delete btn btn-sm btn-outline-danger" 
														onclick="return confirm('Are you sure you want to delete this workflow ?');">
													<span class="btn-opt">
														<i class="fa fa-trash" aria-hidden="true"></i>
													</span>
												</button>
											</form>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>


						<div>
							<a href="{{ path('workflow_action_create_with_workflow', {'workflowId': workflow.id}) }}" class="btn btn-primary mb-3">
								<i class="fa fa-plus" aria-hidden="true"></i>
								{{ 'view_workflow.add_action'| trans }}
							</a>

						</div>

					</div>
				</div>
				{# LOG #}

			{% else %}
				<p class="display-6">{{ 'list_workflow.empty'|trans }}</p>
			{% endif %}

			<div class="container mt-5">
				<div class="card-header mb-4 card-title-workflow">
					<button id="toggle-logs-btn" class="toggle-button btn btn-outline-secondary btn-sm float-end" 
							data-workflow-id="{{ workflow.id }}">
						<i class="fa fa-plus"></i>
					</button>
					{{ 'view_workflow.logs'|trans | upper }}
				</div>

				<div id="logs-content" class="collapse" style="display: none;">
					<div id="logs-table-container">
						<p class="text-center">{{ 'view_workflow.loading_logs'|trans|default('Loading logs...') }}</p>
					</div>
				</div>

					{% block js %}
						<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
						<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
						<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
						<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>
					{% endblock js %}

					{% block js_workflow_toggle %}
						<script type="text/javascript">
							var pathWorkflowtoggle = "{{ path('workflow_toggle', {'id': workflow.id}) }}";
						</script>
					{% endblock js_workflow_toggle %}

					{% block js_logs_lazy_loading %}
						<script type="text/javascript">
							$(document).ready(function() {
								let logsLoaded = false;
								let logsVisible = false;
								
								$('#toggle-logs-btn').on('click', function() {
									const workflowId = $(this).data('workflow-id');
									const logsContent = $('#logs-content');
									const toggleIcon = $(this).find('i');
									
									if (!logsVisible) {
										logsContent.show();
										toggleIcon.removeClass('fa-plus').addClass('fa-minus');
										logsVisible = true;
										
										if (!logsLoaded) {
											$.ajax({
												url: "{{ path('workflow_show_logs', {'id': workflow.id}) }}",
												type: 'GET',
												headers: {
													'X-Requested-With': 'XMLHttpRequest'
												},
												success: function(response) {
													$('#logs-table-container').html(response.html || response);
													logsLoaded = true;
												},
												error: function(xhr, status, error) {
													$('#logs-table-container').html('<p class="text-danger text-center">Error loading logs: ' + error + '</p>');
												}
											});
										}
									} else {
										logsContent.hide();
										toggleIcon.removeClass('fa-minus').addClass('fa-plus');
										logsVisible = false;
									}
								});
							});
						</script>
					{% endblock js_logs_lazy_loading %}

				{% endblock %}
